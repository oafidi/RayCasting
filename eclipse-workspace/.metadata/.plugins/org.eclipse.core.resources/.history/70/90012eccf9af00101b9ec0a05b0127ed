package dao;

import model.Emprunt;
import java.sql.*;
import java.util.ArrayList;
import java.util.List;

public class EmpruntDao {

    public boolean ajouterEmprunt(Emprunt e) {
        String sql = "INSERT INTO Emprunt(id_livre, id_membre, date_emprunt, date_retour_prevue, statut) VALUES (?, ?, ?, ?, ?)";
        try (Connection conn = DBConnection.getConnection();
             PreparedStatement pst = conn.prepareStatement(sql)) {

            if (!isLivreDisponible(e.getIdLivre())) return false;

            if (nombreEmpruntsEnCours(e.getIdMembre()) >= 3) return false;

            pst.setInt(1, e.getIdLivre());
            pst.setInt(2, e.getIdMembre());
            pst.setDate(3, e.getDateEmprunt());
            pst.setDate(4, e.getDateRetourPrevue());
            pst.setString(5, "en cours");
            pst.executeUpdate();

            setLivreDisponibilite(e.getIdLivre(), "emprunté");

            return true;
        } catch (SQLException ex) {
            ex.printStackTrace();
            return false;
        }
    }

    public boolean retourLivre(int idEmprunt, Date dateRetourEffective) {
        String sql = "UPDATE Emprunt SET date_retour_effective = ?, statut = ? WHERE id_emprunt = ?";
        try (Connection conn = DBConnection.getConnection();
             PreparedStatement pst = conn.prepareStatement(sql)) {

            int idLivre = 0;
            ResultSet rs = conn.createStatement().executeQuery(
                "SELECT id_livre FROM Emprunt WHERE id_emprunt=" + idEmprunt
            );
            if (rs.next()) idLivre = rs.getInt("id_livre");

            pst.setDate(1, dateRetourEffective);
            pst.setString(2, "retourné");
            pst.setInt(3, idEmprunt);
            pst.executeUpdate();

            setLivreDisponibilite(idLivre, "disponible");

            return true;
        } catch (SQLException ex) {
            ex.printStackTrace();
            return false;
        }
    }

    public List<String> getEmpruntsEnCours() {
        List<String> emprunts = new ArrayList<>();
        String sql = "SELECT e.id_emprunt, l.titre, m.nom, m.prenom, e.date_emprunt, e.date_retour_prevue, e.statut " +
                     "FROM Emprunt e " +
                     "JOIN Livre l ON e.id_livre = l.id_livre " +
                     "JOIN Membre m ON e.id_membre = m.id_membre " +
                     "WHERE e.statut='en cours'";
        try (Connection conn = DBConnection.getConnection();
             Statement st = conn.createStatement();
             ResultSet rs = st.executeQuery(sql)) {

            while (rs.next()) {
                String info = "Emprunt #" + rs.getInt("id_emprunt") + 
                              " - Livre: " + rs.getString("titre") +
                              " - Membre: " + rs.getString("nom") + " " + rs.getString("prenom") +
                              " - Date emprunt: " + rs.getDate("date_emprunt") +
                              " - Date retour prévue: " + rs.getDate("date_retour_prevue");
                emprunts.add(info);
            }

        } catch (SQLException ex) {
            ex.printStackTrace();
        }
        return emprunts;
    }

    private boolean isLivreDisponible(int idLivre) throws SQLException {
        String sql = "SELECT statut_disponibilite FROM Livre WHERE id_livre=?";
        try (Connection conn = DBConnection.getConnection();
             PreparedStatement pst = conn.prepareStatement(sql)) {
            pst.setInt(1, idLivre);
            ResultSet rs = pst.executeQuery();
            if (rs.next()) {
                return rs.getString("statut_disponibilite").equals("disponible");
            }
        }
        return false;
    }

    private void setLivreDisponibilite(int idLivre, String statut) throws SQLException {
        String sql = "UPDATE Livre SET statut_disponibilite=? WHERE id_livre=?";
        try (Connection conn = DBConnection.getConnection();
             PreparedStatement pst = conn.prepareStatement(sql)) {
            pst.setString(1, statut);
            pst.setInt(2, idLivre);
            pst.executeUpdate();
        }
    }

    private int nombreEmpruntsEnCours(int idMembre) throws SQLException {
        String sql = "SELECT COUNT(*) as nbr FROM Emprunt WHERE id_membre=? AND statut='en cours'";
        try (Connection conn = DBConnection.getConnection();
             PreparedStatement pst = conn.prepareStatement(sql)) {
            pst.setInt(1, idMembre);
            ResultSet rs = pst.executeQuery();
            if (rs.next()) return rs.getInt("nbr");
        }
        return 0;
    }
}
